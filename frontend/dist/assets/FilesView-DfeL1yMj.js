import{c as B,a as z}from"./index-ClTo44m5.js";/* empty css                        *//* empty css               *//* empty css                  *//* empty css                 *//* empty css                    *//* empty css                     */import{B as Z,_ as q,O as Q,$ as Y,P as ee}from"./element-plus-icons-DT1t6uiv.js";import{_ as te}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as oe,A as ae,b as le,x as se,w as ne,u as ie,e as re,B as de,v as ce,l as ue,j as pe,p as fe,s as me,h as c,n as _e,o as ge}from"./element-plus-Bsbl4o2M.js";import{r as m,b as ve,c as he,B as we,H as be,I as M,J as r,Z as o,S as l,W as d,u as g,T as ye,R as xe,X as C}from"./vue-BsGzy4bG.js";import"./pinia-Daj9vj9Q.js";import"./vue-router-DQ646c9T.js";const Be={class:"files-container"},Ce={class:"files-header"},ke={class:"mt-4"},Ee={class:"dialog-footer"},ze={class:"file-name"},Ue={class:"mt-4 flex justify-center"},Ve={__name:"FilesView",setup(Me){const v=m(!1),U=m(null),u=ve({description:"",isPublic:!1}),k=m([]),E=m(!1),h=m(1),w=m(10),V=m(0),x="http://localhost:8000",F=he(()=>B().Authorization||""),b=async()=>{E.value=!0;try{const t=await z.get(`${x}/files/`,{headers:B(),params:{skip:(h.value-1)*w.value,limit:w.value}});t.data.code===200?(k.value=t.data.data.files||[],V.value=t.data.data.total||0):c.error("获取文件列表失败")}catch(t){console.error("获取文件列表失败:",t),c.error("获取文件列表失败，请检查网络连接")}finally{E.value=!1}},S=()=>{v.value=!0},$=()=>{U.value.submit()},D=t=>{t.code===201?(c.success("文件上传成功"),v.value=!1,u.description="",u.isPublic=!1,b()):c.error("文件上传失败")},T=t=>{console.error("文件上传失败:",t),c.error("文件上传失败，请重试")},L=async t=>{try{const e=await z.get(`${x}/files/download/${t}`,{headers:B(),responseType:"blob"}),n=window.URL.createObjectURL(new Blob([e.data])),s=document.createElement("a");s.href=n;const y=e.headers["content-disposition"];let p="file-download";if(y){const i=y.match(/filename="(.+)"/i);if(i&&i.length>1)p=i[1];else{const f=y.match(/filename=([^;]+)/i);f&&f.length>1&&(p=f[1].trim())}}else{const i=k.value.find(f=>f.id===t);i&&i.filename?p=i.filename:p=`file-${t}`}s.setAttribute("download",p),document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(n)}catch(e){console.error("文件下载失败:",e),c.error("文件下载失败，请检查网络连接或权限")}},P=async t=>{try{await _e.confirm("确定要删除这个文件吗？","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await z.delete(`${x}/files/${t}`,{headers:B()})).data.code===200?(c.success("文件删除成功"),b()):c.error("文件删除失败")}catch(e){e!=="cancel"&&(console.error("文件删除失败:",e),c.error("文件删除失败，请重试"))}},N=t=>{w.value=t,h.value=1,b()},R=t=>{h.value=t,b()},j=t=>{if(!t)return"0 B";const e=1024,n=["B","KB","MB","GB","TB"],s=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,s)).toFixed(2))+" "+n[s]},A=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"";return we(()=>{b()}),(t,e)=>{const n=oe,s=le,y=ae,p=ie,i=ne,f=re,I=se,H=de,_=ue,O=pe,G=ge,J=fe,K=me,W=ce;return M(),be("div",Be,[r("div",Ce,[e[11]||(e[11]=r("h1",{class:"text-2xl font-bold mb-2"},"文件管理",-1)),e[12]||(e[12]=r("p",{class:"text-gray-500 dark:text-gray-400 mb-4"},"上传和管理你的文件",-1)),o(n,{type:"primary",icon:g(Z),class:"mb-4",onClick:S},{default:l(()=>[...e[6]||(e[6]=[d(" 上传文件 ",-1)])]),_:1},8,["icon"]),o(H,{modelValue:v.value,"onUpdate:modelValue":e[3]||(e[3]=a=>v.value=a),title:"上传文件",width:"500px"},{footer:l(()=>[r("span",Ee,[o(n,{onClick:e[2]||(e[2]=a=>v.value=!1)},{default:l(()=>[...e[9]||(e[9]=[d("取消",-1)])]),_:1}),o(n,{type:"primary",onClick:$},{default:l(()=>[...e[10]||(e[10]=[d("确定上传",-1)])]),_:1})])]),default:l(()=>[o(y,{drag:"",action:g(x)+"/files/upload",headers:{Authorization:F.value},"on-success":D,"on-error":T,"auto-upload":!1,ref_key:"uploadRef",ref:U,accept:"*/*"},{tip:l(()=>[...e[7]||(e[7]=[r("div",{class:"el-upload__tip text-sm text-gray-500"}," 支持多种文件格式，单个文件大小不超过 100MB ",-1)])]),default:l(()=>[o(s,{class:"el-icon--upload"},{default:l(()=>[o(g(q))]),_:1}),e[8]||(e[8]=r("div",{class:"el-upload__text"},[d(" 拖拽文件到此处或"),r("em",null,"点击上传")],-1))]),_:1},8,["action","headers"]),r("div",ke,[o(I,{model:u,"label-width":"80px"},{default:l(()=>[o(i,{label:"描述"},{default:l(()=>[o(p,{modelValue:u.description,"onUpdate:modelValue":e[0]||(e[0]=a=>u.description=a),placeholder:"请输入文件描述",type:"textarea",rows:"2"},null,8,["modelValue"])]),_:1}),o(i,{label:"是否公开"},{default:l(()=>[o(f,{modelValue:u.isPublic,"onUpdate:modelValue":e[1]||(e[1]=a=>u.isPublic=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"])]),o(K,{class:"files-card"},{default:l(()=>[ye((M(),xe(G,{data:k.value,stripe:"",style:{width:"100%"},"scroll-y":400,height:"400"},{default:l(()=>[o(_,{prop:"filename",label:"文件名","min-width":"200"},{default:l(a=>[r("div",ze,[o(s,{class:"mr-2"},{default:l(()=>[o(g(Q))]),_:1}),d(" "+C(a.row.filename),1)])]),_:1}),o(_,{prop:"file_size",label:"文件大小",width:"120"},{default:l(a=>[d(C(j(a.row.file_size)),1)]),_:1}),o(_,{prop:"file_type",label:"文件类型",width:"120"}),o(_,{prop:"is_public",label:"是否公开",width:"100"},{default:l(a=>[o(O,{type:a.row.is_public?"success":"info"},{default:l(()=>[d(C(a.row.is_public?"是":"否"),1)]),_:2},1032,["type"])]),_:1}),o(_,{prop:"created_at",label:"上传时间",width:"180"},{default:l(a=>[d(C(A(a.row.created_at)),1)]),_:1}),o(_,{label:"操作",width:"150",fixed:"right"},{default:l(a=>[o(n,{type:"primary",size:"small",icon:g(Y),onClick:X=>L(a.row.id),class:"mr-2"},{default:l(()=>[...e[13]||(e[13]=[d(" 下载 ",-1)])]),_:1},8,["icon","onClick"]),o(n,{type:"danger",size:"small",icon:g(ee),onClick:X=>P(a.row.id)},{default:l(()=>[...e[14]||(e[14]=[d(" 删除 ",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[W,E.value]]),r("div",Ue,[o(J,{"current-page":h.value,"onUpdate:currentPage":e[4]||(e[4]=a=>h.value=a),"page-size":w.value,"onUpdate:pageSize":e[5]||(e[5]=a=>w.value=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:V.value,onSizeChange:N,onCurrentChange:R},null,8,["current-page","page-size","total"])])]),_:1})])}}},Oe=te(Ve,[["__scopeId","data-v-f5b7e518"]]);export{Oe as default};
